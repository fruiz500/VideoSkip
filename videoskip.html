<!doctype html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" manifest="videoskip.appcache">
<head>
<meta charset="UTF-8">
<title>Video Skip player</title>
<meta name="Description" content="Video Skip player">
<meta name="author" content="F. Ruiz">
<meta name="robots" content="index">
<link rel="shortcut icon" type="image/x-icon" href="favicon.png">

<style>
video {
    display: block;
  z-index: 0;
}
video:focus {
  outline: none;
}
input[type=checkbox] {
  /* Larger checkboxes */
  -ms-transform: scale(1.7); /* IE */
  -moz-transform: scale(1.7); /* FF */
  -webkit-transform: scale(1.7); /* Safari and Chrome */
  -o-transform: scale(1.7); /* Opera */
  padding: 0px;
  cursor: pointer;
  border: 1px solid #dedede;
}
.info {
    background-color: palegreen;            
}
.error {
    background-color: red;
    color: white;
}
#skipBox {
  height: 250px;
  width: 356px;
  background: #fffffc;
  z-index: 2;
}
#boxMsg {
  color: blue;
  z-index: 2;
}
#videoFile {
  display: none;
}
#subFile {
  display: none;
}
#skipFile {
  display: none;
}
#screenShot {
  z-index: 1;
}
.cssbutton {
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  border-radius: 10px;
  font-family: Arial;
  font-size: 18px;
  padding: 12px;
  text-decoration: none;
  border: 0px;
  color: #555555;
  background: #e6e6e6;
  z-index: 2;
}
.cssbutton:hover {
  text-decoration: none;
  cursor: pointer;
  background: #c4c4c4;
}
.small {
  font-size: 12px;
  padding: 9px;
}
.fineText {
  font-size: small;
  color: gray;
}
#credits {
  font-size: xx-small;
}
</style>

<script>
        /*
    @source: https://github.com/fruiz500/VideoSkip

        @licstart  The following is the entire license notice for the
        JavaScript code in this page.

        Copyright (C) 2020  Francisco Ruiz

        The JavaScript code in this page is free software: you can
        redistribute it and/or modify it under the terms of the GNU
        General Public License (GNU GPL) as published by the Free Software
        Foundation, either version 3 of the License, or (at your option)
        any later version.  The code is distributed WITHOUT ANY WARRANTY;
        without even the implied warranty of MERCHANTABILITY or FITNESS
        FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

        As additional permission under GNU GPL version 3 section 7, you
        may distribute non-source (e.g., minimized or compacted) forms of
        that code without the copy of the GNU GPL normally required by
        section 4, provided you include this license notice and a URL
        through which recipients can access the Corresponding Source.


        @licend  The above is the entire license notice
        for the JavaScript code in this page.
        */

    if (window.location.protocol == "http:") {        //force SSL/TLS

        var restOfUrl = window.location.href.substr(5);
        window.location = "https:" + restOfUrl;
    }
</script>

</head>

<body>                    
  <h2>Video Skip Player</h2>
    <p>v 0.1.3 &nbsp;&#169; F. Ruiz 2020</p>
<div id="videoMsg">Load video file with left button, .vtt or .srt subtitles with right button</div>
<br>
<label for="videoFile"><span class="cssbutton" id="videoFileBtn" title="load .mp4, .ogg, .webm video file">Load video</span></label>
<input type="file" id="videoFile" accept="video/*"/>
<label for="subFile"><span class="cssbutton" id="subFileBtn" title="load .vtt, .srt subtitles; then enable them in the video">Load subtitles</span></label>
<input type="file" id="subFile"/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button id="help" class="cssbutton" title="toggle instructions">Help</button><br>
<br>
<video controls disablePictureInPicture id="myVideo"></video>
    <br>
    Select the content to skip:
    <br><br>
    <div id="checkBoxes">
    &nbsp;&nbsp;
    <input type="checkbox" id="sexMode"/>&nbsp;Sex and Nudity&nbsp;&nbsp;
    <input type="checkbox" id="violenceMode"/>&nbsp;Violence and Gore&nbsp;&nbsp;
    <input type="checkbox" id="curseMode"/>&nbsp;Profanity and Hate&nbsp;&nbsp;
    <input type="checkbox" id="boozeMode"/>&nbsp;Alcohol, Drugs and Smoking&nbsp;&nbsp;
    <input type="checkbox" id="scareMode"/>&nbsp;Frightening and Intense&nbsp;&nbsp;
    <input type="checkbox" id="otherMode"/>&nbsp;Other
    </div>
    <br>
    <div id="boxMsg">Load here the .skp file containing the skips:</div>
    <br>
    <label for="skipFile"><span class="cssbutton" id="skipFileBtn" title="load .skp file">Load skip file</span></label>
  <input type="file" id="skipFile"/>
    <br><br>
    Edit skips&nbsp;&nbsp;
    <button id="timeBtn" class="cssbutton small" title="insert current time">Insert time</button>
    <button id="arrowBtn" class="cssbutton small" title="insert a correctly formatted arrow">Insert arrow</button>
    <button id="shiftBtn" class="cssbutton small" title="delay or advance by given seconds; leave empty to sort by time">Shift skips</button>
    <button id="saveFile" class="cssbutton small" title="save .skp file to Downloads">Save</button>
        &nbsp;&nbsp;
    <button id="backBtn"class="cssbutton small" title="step rewind / go to previous time">&#9668;</button>
    <input type="checkbox" id="fineMode"/ title="frame by frame">&nbsp;<span class="fineText">Fine</span>&nbsp;
    <input type="checkbox" id="shiftMode" title="shift selected time with arrows"/>&nbsp;<span class="fineText">Shift</span>
    <button id="fwdBtn"class="cssbutton small" title="step advance / go to next time">&#9658;</button>
    <button id="fFwdBtn"class="cssbutton small" title="toggle Fast Forward / resume">&#9658;&#9658;</button>
    <button id="shotTimeBtn"class="cssbutton small" title="go to selected time / screenshot time">Go to time</button>
    <button id="moveBtn" class="cssbutton small" title="overlay shot on video">Superimpose</button>
    <button id="syncBtn"class="cssbutton small" title="change all times when video and shot match">Sync times</button>
    <button id="shotBtn"class="cssbutton small" title="take screenshot">Take screenshot</button>
    <br>
  <textarea id="skipBox" rows="10" placeholder="Skips appear here"></textarea>
    &nbsp;&nbsp;&nbsp;<img id="screenShot">
    <br>
<div id="instructions">
  <h2>Instructions</h2>   
<p> This little app allows you to filter out several types of objectionable content from downloaded video files. It uses the same categories as the &quot;Parents Guide&quot; section of IMDB.com. It can skip sections entirely, or simply mute the sound or blank the video, at your discretion. Skip files can be shared at the official VideoSkip Exchange, or any way you want. The exchange is at <a href="https://prgomez.com/videoskip/exchange" target="_blank">https://prgomez.com/videoskip/exchange</a> There is also an exension version of this app, available from the Chrome and Firefox web stores, which works on streaming video from any source.</p>
<p>Step by step:</p>
<ol>
  <li>Load the video from a local file using the &quot;Load video&quot; button. Because the video must be playable in a browser, it can take .mp4, .ogg, and .webm formats. You can save videos from streaming sources in these formats, rip a disc using software, or convert video files into these formats from a different format (more information below).</li>
  <li>Optionally, load a file containing subtitles using the &quot;Load subtitles&quot;. Subtitles must be in .vtt or .srt format. They might show as &quot;English&quot; but never mind.</li>
  <li>Toggle the category filters using the checkboxes below the video frame. A check means that the filter is on and content labeled accordingly will be skipped or blanked out. Otherwise it will be shown.</li>
  <li>If you have a .skp file containing the skips, you can load it now with the &quot;Load skip file&quot; button. Once loaded, its contents will appear in the box, plus perhaps a screenshot on its right. Each skip consists of  beginning and end times relative to the start of the video, with an arrow between them, and on the line below a category plus maybe a handling label (such as &quot;video&quot; or &quot;audio&quot;).</li>
  <li>If the first line contains only one time, this means it is used for syncing the skips for different versions of the video. The process for syncing, explained below, can be done at this point. If when you click the &quot;Go to time&quot; button the video shows the same image as the screenshot everything is in sync.</li>
  <li>If you want to change something in the list of skips, go right ahead. There's a button to insert the current time on the video (the video itself has a scrub bar to get there), and a correctly formatted &quot;arrow&quot; if you feel lazy. There are also buttons for shifting the time of all skips by a given amount, and for saving your edited skip list.</li>
  <li>Click the play button on the video, and maybe the fullscreen button, sit back, and enjoy. Skips will take place when their time arrives.</li>
  </ol>
<p>How to sync the skips:</p>
<ol>
  <li>There may be a screenshot, but  there is none, likely there is some text below the initial time entry that will tell you what happens in the video at that time. Click the &quot;Go to time&quot; button to take the video to that time. If the video matches the screenshot (or the literal description, if there is no screenshot), everything is in sync and you're done with this phase. Scrub the video back to the beginning and start watching.</li>
  <li>But if the video is from a source different from that used to make the sync file, there may be a mismatch. Use the arrow buttons to scrub the video until the screen matches the screenshot or description (frame by frame, if  &quot;Fine&quot; is checked). The fast forward button toggles the speed, or resumes playing if paused. If there's a screenshot, the &quot;Superimpose&quot; button will put it right on top of the video, so you can see the precise moment when they match. If the picture does not match the video, you can move it around with the arrow keys, and resize it if you also hold the Alt key. Hold Shift for fine corrections.</li>
  <li>Click the &quot;Sync times&quot; button when video and screenshot match. This will shift all the skips by the right amount, so they wil happen at the correct times.</li>
  <li>If the screenshot is still on top of the video, click &quot;Superimpose&quot; again in order to put it back in its place.</li>
</ol>
<p>Getting the video files:</p>
<ul>
  <li>If you are using a streaming service, these often allow you to pre-download the complete video in order to avoid stuttering on low-badwidth connections. YouTube and Vimeo videos are very easy to get this way (Google it), but other services may use copy-protection schemes that will need to be removed before you can use the file.</li>
  <li>If the video is in a DVD or BlueRay disc that your own, there are excellent programs that will extract the data into whatever format you choose. Currently my favorite is Handbrake, available for <a href="https://handbrake.en.softonic.com/" target="_blank">Windows</a> and for <a href="https://handbrake.en.softonic.com/mac" target="_blank">Mac</a>.</li>
  <li>Or you may have an old .avi, .mkv, or some other format. Handbrake can also convert the file from those formats into .mp4. A feature film may take an hour of processing. There are online converters as well, but they usually limit how much processing you can do in one day.</li>
  <li>Another way to get them is by sharing with others, via BitTorrent or similar protocol. Be advised that this is not always legal.</li>
  <li>Subtitles in .srt format are very easy to find online. This app will load them in this format, but if you want to convert them to .vtt there are easy online utilities like <a href="https://atelier.u-sub.net/srt2vtt/" target="_blank">this one</a>.</li>
</ul>
<p>Making your own skips:</p>
<ul>
  <li>As mentioned above, inserting new skips is as easy as scrubbing to the point where the skip/mute/blank is supposed to begin, clicking the &quot;Insert time&quot; button on a new line, then the &quot;Insert arrow&quot; button, scrubbing to the point where the skip is to end, clicking the &quot;Insert time&quot; button once more, and then going to the next line and writing a content and (optionally) handling label. If you are initially unsure of where the skips should be inserted, there is a &quot;Fast Forward&quot; button that scrubs the video at high speed. Click it again to return to normal speed. The button to its left stops the video when it's running.</li>
  <li>Content labels are case-insensitive. They consist of any word (actually, the first three letters are enough) of the IMDB categories, which are displayed next to the checkboxes, such as &quot;sex&quot;, &quot;nudity&quot;, &quot;gore&quot;, &quot;drugs&quot;, etc. Handling labels are these words: &quot;audio&quot;, &quot;sound&quot;, &quot;video&quot;, &quot;image&quot; (or the first three letters of each, including &quot;img&quot;) also case-insensitive.</li>
  <li>The &quot;audio&quot; or &quot;sound&quot; keywords will cause the sound to be muted during the given interval while the video is still shown, rather than skipping the section entirely, which might be useful for removing profanity. The &quot;video&quot; and &quot;image&quot; keywords cause the image to blank out while the sound still plays, which might be useful for instances of nudity, etc. No handling keyword means that the section will be completely skipped.</li>
  <li>Everything is editable in the box. Use this to fine-tune timings. For instance, words to be muted typically take a lot less than a second. You can review each timing by selecting on the list and clicking &quot;Go to time&quot;, or by clicking the forward and back buttons when a time is selected on the list. If the &quot;Shift&quot; box is checked, the selected timing will shift with the arrows, rather than moving to another timing.</li>
  <li>The &quot;Insert&quot; buttons put things always at the current cursor position. In any case, skips will be made at the right times even though they may not be in sequence on the list.</li>
  <li>The &quot;Shift skips&quot; button opens a dialog where you can enter a number of seconds to delay all skips, or advance them if you enter a negative number, including the screenshot time at the top, if any. Clicking OK with nothing entered sorts the skips in ascending order of start times leaving the screenshot time at the top, if any, unchanged.</li>
  <li>The &quot;Save&quot; button will save your list, plus optional screenshot, in .skp format in your default Download folder. You will have to move it from there to the folder where you want it. This format is text-based, so you can view the file in any text editor.</li>
  <li>A well-constructed skip file will have a first entry  with the timing of an event near the start of the video that viewers can recognize accurately (for instance, the moment the screen first goes dark, or when a certain logo changes) or a screenshot (best if the image is changing quickly at that point), plus a description of it on the line below it (do not use numbers in the description). This is to allow viewers to use the skips in the file even if they are watching a video obtained from a different source, which might have a slightly different timing. It is best to make this entry at the start of the process. To take a screenshot, just scrub the video to the desired time and click &quot;Take screenshot&quot;; the time will be added at the beginning of the skip list.</li>
  </ul>
<p>Sample skip, which will cause the screen to blank out from 14 minutes, 8.27 seconds from the start of the movie until 14 minutes, 14 seconds, while the sound still plays, if &quot;Sex and Nudity&quot; is checked:</p>
<p>0:14:08.27 --&gt; 0:14:14<br>
  nude image</p>
<p>Legal Notice: Content copyright owners and distributors are hereby informed that users and developers of this software are exercising their right of free speech, guaranteed by law in many nations, by voluntarily refraining from seeing or hearing content without modifying said content in any way. Legal action that ignores this notice will be considered harassment and infringement of basic rights, and prosecuted according to the law.</p>
<div id='credits'>
<div>Favicon made by <a href="https://www.flaticon.com/authors/smashicons" title="Smashicons">Smashicons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
</div>
</div>
<script>

((
/*
* Load video from a local file. Implemented by Dimitar Bonev as answered on StackOverflow.
*
* @link https://jsfiddle.net/dsbonev/cCCZ2/
*/
function localFileVideoPlayer() {
  var URL = window.URL || window.webkitURL;

  var playSelectedFile = function (event) {
    // Obtain file and properties.
    var file = this.files[0]
    var type = file.type
    var videoNode = document.querySelector('video')
    var canPlay = videoNode.canPlayType(type)
    if (canPlay === '') canPlay = 'no'
    var message = 'Can play type "' + type + '": ' + canPlay
    var isError = canPlay === 'no'
    displayMessage(message, isError)

    // Will return if the attached file cannot be played.
    if (isError) {
      return
    }

    var fileURL = URL.createObjectURL(file)
    videoNode.src = fileURL;

    setTimeout(
      function() {
        cuts = PF_SRT.parse(skipBox.value); setActions(); makeTimeLabels()
      },
      1000
    )
  }

  // Link event playSelectedFile to input of HTML.
  var inputNode = document.querySelector('input')
  inputNode.addEventListener('change', playSelectedFile, false)
})();


/*
* Display a message  in the #videoMsg element from HTML.
*
* @param {String} message - Message to be displayed in the HTML object.
* @param {String} isError - String representing whether is an error message.
*/
var displayMessage = function (message, isError) {
  var element = document.querySelector('#videoMsg')
  element.innerHTML = message
  element.className = isError ? 'error' : 'info'
}

// TODO: Check for variables to be changed for let
//global variable with name of skip file, minus extension
var name = '';
/*
* global variable containing the cuts, each array element is an object with this format:
* {startTime, endTime, text, action}
*/
var cuts = [];

//to add a fix for Safari and choose fastest filter method, per https://jsben.ch/5qRcU
var ua = navigator.userAgent.toLowerCase();
// check navigator user agent.
if (ua.indexOf('safari') != -1) { 
  if (ua.indexOf('chrome') == -1) { 
    var isSafari = true
  } else { 
    var isChrome = true
  }
} else if (typeof InstallTrigger !== 'undefined') {
  var isFirefox = true
} else if (document.documentMode || /Edge/.test(navigator.userAgent)) {
  var isEdge = true
}
//file loading fix
if (isSafari) videoFile.accept = 'video/mp4,video/x-m4v,video/*';

/*
* Loads the skips file.
*/
function loadFileAsURL() {
  // Store file to read and create an object for reading the file.
  var fileToLoad = skipFile.files[0], fileReader = new FileReader();
  
  fileReader.onload = function(fileLoadedEvent) {
    var URLFromFileLoaded = fileLoadedEvent.target.result;
    var extension = fileToLoad.name.slice(-4);

    if (extension == ".skp") {
      //separate skips from screenshot
      var data = URLFromFileLoaded.split('data:image/jpeg;base64,');
      name = fileToLoad.name.slice(0,-4);
      skipBox.value = data[0].trim();
      if (data[1]) screenShot.src = 'data:image/jpeg;base64,' + data[1];
    } else {
      boxMsg.textContent = "wrong file type"
    }
  };

  fileReader.readAsText(fileToLoad);
  boxMsg.textContent = 'This is the content of file: ' + fileToLoad.name;

  //give it a whole second to load before data is extracted to memory
  setTimeout(
    function() {
      cuts = PF_SRT.parse(skipBox.value); 
      setActions(); 
      makeTimeLabels()
    },
    1000
  )
}

/*
* Load subtitles file.
*/
function loadSubs(){
  var fileToLoad = subFile.files[0], fileReader = new FileReader();

  fileReader.onload = function(fileLoadedEvent) {
    var URLFromFileLoaded = fileLoadedEvent.target.result;
    var extension = fileToLoad.name.slice(-4);
    
    // allow only .vtt and .srt formats
    if (extension == ".vtt" || extension == ".srt") {
      track = document.createElement("track");
      track.kind = "captions";
      track.label = "Loaded";
      track.srclang = "en";

      if (extension == ".vtt") {
        track.src = URL.createObjectURL(fileToLoad)
      } else {
        //get subs in text format, to be edited
        var subs = URLFromFileLoaded;
        //convert decimal commas to periods and add header
        subs = 'WEBVTT\n\n' + subs.replace(/(\d),(\d)/g,'$1.$2');
        var subBlob = new Blob([subs], {"type": 'text/plain'});
        track.src = URL.createObjectURL(subBlob);
      }

      track.addEventListener("load", function() { 
        this.mode = "showing";
        myVideo.textTracks[0].mode = "showing"; // thanks Firefox
      });

      myVideo.appendChild(track);
      displayMessage(
        "Subtitles loaded. Enable them in the video with lower right icon", 
        false
      )
    } else {
      displayMessage("Only .vtt  and .srt subs are supported",true)
    }
  };
  fileReader.readAsText(fileToLoad)
}

/*
* Download data to a file.
*
* @link StackOverflow
*
* @param {Object} data     - Data to be extracted.
* @param {String} filename - Path of the file.
* @param {String} type     - Type of the data to download.
*/
function download(data, filename, type) {
  // create new HTML element.
  var a = document.createElement("a");
  var file = new Blob([data], {"type": type}), url = URL.createObjectURL(file);
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  
  setTimeout(
    function() {
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);  
    }, 
    0
  )
}

/*
* Parse the content of the skip box in something close to .srt format.
*
* @link StackOverflow
*/
var PF_SRT = function() {
  //SRT format
  //no item number, can use decimal dot instead of comma
  var pattern = /([\d:,.]+)\s+-{2}\>\s+([\d:,.]+)\n([\s\S]*?(?=\n{2}|$))?/gm;
  var _regExp;

  var init = function() {
    _regExp = new RegExp(pattern);
  };

  var parse = function(f) {
    if (typeof(f) != "string")
      throw "Sorry, the parser accepts only strings";

    var result = [];
    if (f == null)
      return _subtitles;

    f = f.replace(/\r\n|\r|\n/g, '\n')

    while ((matches = pattern.exec(f)) != null) {
      result.push(toLineObj(matches));
    }
    return result;
  }

  var toLineObj = function(group) {
    return {
      startTime: fromHMS(group[1]),
      endTime: fromHMS(group[2]),
      text: group[3],
      //no action by default, to be filled later
      action: ''
    };
  }

  init();

  return {
    parse: parse
  }
}();

//to put seconds into hour:minute:second format
/*
* Convert seconds into hour:minute:second.
*
* @param {Number} seconds - Total seconds to re-format.
*
* @return {String} Seconds with format hour:minute:second.
*/
function toHMS(seconds) {
  var hours = Math.floor(seconds / 3600);
  seconds -= hours * 3600;
  var minutes = Math.floor(seconds / 60);
  minutes = (minutes >= 10) ? minutes : "0" + minutes;
  seconds = Math.floor((seconds % 60) * 100) / 100;     //precision is 0.01 s
  seconds = (seconds >= 10) ? seconds : "0" + seconds;
  
  return hours + ":" + minutes + ":" + seconds;
}
  
/*
* Convert hour:minute:second string to seconds.
*
* @param {String} timeString - Time in format hour:minute:second
*
* @return {Number} Float representing total seconds.
*/
function fromHMS(timeString){
  //in .srt format decimal seconds use a comma
  timeString = timeString.replace(/,/,".");
  var time = timeString.split(":");

  // Check if it has hours
  if(time.length == 3) {              
    return parseInt(time[0])*3600 + parseInt(time[1])*60 + parseFloat(time[2])
  // Case only minutes and seconds
  } else if (time.length == 2) {
    return parseInt(time[0])*60 + parseFloat(time[1])
  // Case only seconds
  } else {
    return parseFloat(time[0])
  }
}

/*
* Shifts all times by a number of seconds entered in prompt.
*/
function shiftTimes() {
  var reply = prompt(
        'Enter seconds to delay skips (negative for advance), or leave empty to sort the timings in ascending order'
      );
  
  // Return if there was no reply.
  if (reply == null) {
    boxMsg.textContent = 'Time shift canceled'; 
    return
  };
  
  // first two lines
  var initialData = skipBox.value.trim().split('\n').slice(0,2);
  var shotTime = fromHMS(initialData[0]);
  
  // Case number entered, so apply the given shift
  if (reply) {
    var seconds = parseFloat(reply);
    for (var i = 0; i < cuts.length; i++) {
      cuts[i].startTime += seconds;
      cuts[i].endTime += seconds
    }
  // nothing entered, so sort the times in ascending order
  } else {
    cuts.sort(function(a, b){return a.startTime - b.startTime;})
  }
  // put shifted times in the box
  times2box();
  
  // reconstruct initial data, if present
  if (shotTime) {
    if (seconds) initialData[0] = toHMS(shotTime + seconds);
    skipBox.value = initialData.join('\n') + '\n\n' + skipBox.value
  }
  if (!seconds) {
    boxMsg.textContent = "Skips sorted by start time"
  } else if (seconds >= 0) {
    boxMsg.textContent = "Skips delayed by " + Math.floor(seconds*100)/100 + " seconds"
  } else {
    boxMsg.textContent = "Skips advanced by " + Math.floor(- seconds*100)/100 + " seconds"
  }

  setTimeout(
    function() {
      makeTimeLabels(); 
      if (isSuper) moveShot()
    },
    100
  )
}

/*
* Shift all times so the screenshot has correct timing in the video. 
* ShiftTimes also has this functionality, with empty input.
*/
function syncTimes() {
  //first two lines
  // TODO: Check indenting here.
  var initialData = skipBox.value.trim().split('\n').slice(0,2),
    shotTime = fromHMS(initialData[0]),
    seconds = shotTime ? myVideo.currentTime - shotTime : 0;
  
  for (var i = 0; i < cuts.length; i++) {
    cuts[i].startTime += seconds;
    cuts[i].endTime += seconds
  }
  // put shifted times in the box
  times2box();
  
  //reconstruct initial data, if present
  if (shotTime) {
    initialData[0] = toHMS(shotTime + seconds);
    skipBox.value = initialData.join('\n') + '\n\n' + skipBox.value
  }

  if (seconds >= 0) {
    boxMsg.textContent = "Skips delayed by " + Math.floor(seconds*100)/100 + " seconds"
  } else {
    boxMsg.textContent = "Skips advanced by " + Math.floor(- seconds*100)/100 + " seconds"
  }

  setTimeout(
    function() {
      makeTimeLabels(); 
      if (isSuper) moveShot()
    },
    100
  )
}

/*
* Put data from the cuts array into skipBox.
*/
function times2box(){
  var text = '';
  for (var i = 0; i < cuts.length; i++) {
    text += toHMS(cuts[i].startTime) + ' --> ' + toHMS(cuts[i].endTime) + '\n' + cuts[i].text + '\n\n'
  }
  skipBox.value = text.trim();
  setTimeout(
    function() {
      makeTimeLabels()
    },
    100
  )
}

/* 
* Insert string in box, at cursor or replacing selection.
*
* @param {String}  string  - Text to insert.
* @param {Boolean} isScrub - Boolean.
*/
function writeIn(string,isScrub) {
  var start = skipBox.selectionStart,
    end = skipBox.selectionEnd,
    newEnd = start + string.length;
  skipBox.value = skipBox.value.slice(0,start) + string + skipBox.value.slice(end,skipBox.length);
  
  if (isScrub) {
    skipBox.setSelectionRange(start,newEnd)
  } else {
    skipBox.setSelectionRange(newEnd,newEnd);
  }
  
  setTimeout(
    function() { 
      cuts = PF_SRT.parse(skipBox.value); 
      setActions(); 
      makeTimeLabels()
    },
    100
  );

  skipBox.focus()
}

/*
* Gets index of a particular HMS time in the box
*
* @param {String} string - Text to obtain the index from.
*/
function getTimeIndex(string) {
  var stringStart = skipBox.value.indexOf(string);
  
  for (var i = 0; i < timeLabels[0].length; i++) {
    if (timeLabels[0][i].match(string)) return i
  }
}

// for screenshots
var canvas = document.createElement('canvas');
// for full scale: myVideo.videoWidth - 100 
canvas.width = 320;
canvas.height = 240;
var ctx = canvas.getContext('2d')

/* 
* Take a screen shot.
*/
function makeShot() {
  myVideo.pause();
  //put time at start
  skipBox.value = toHMS(myVideo.currentTime) + '\n' + skipBox.value;
  // draw image to canvas. scale to target dimensions
  canvas.width = myVideo.videoWidth / myVideo.videoHeight * canvas.height;
  ctx.drawImage(myVideo, 0, 0, canvas.width, canvas.height);

  // convert to desired file format
  // can also use 'image/png' but the file is 10x bigger
  var dataURI = canvas.toDataURL('image/jpeg');
  screenShot.src = dataURI
}

/*
* Forwar Skip part of the video.
*
* Called by forward button
*/
function fwdSkip() {
  if (myVideo.paused) {
    var selection = skipBox.value.slice(skipBox.selectionStart,skipBox.selectionEnd).trim();
    // valid time selected, so scrub to next time
    if (selection != '' && !selection.match(/[^\d:.]/)) {
      var index = getTimeIndex(selection);
      
      if (index != null) {
        if (shiftMode.checked) {
          // first go there
          myVideo.currentTime = fromHMS(timeLabels[0][index]);
          // now scrub by a small amount
          myVideo.currentTime += fineMode.checked ? 0.0417 : 0.417;
          // and write it in
          writeIn(toHMS(myVideo.currentTime),true);
          skipBox.focus()
        } else {
          var nextIndex = index + 1;
          if (nextIndex >= timeLabels[0].length) nextIndex = 0;
          myVideo.currentTime = fromHMS(timeLabels[0][nextIndex]);
          skipBox.selectionStart = timeLabels[1][nextIndex];
          skipBox.selectionEnd = timeLabels[2][nextIndex];
          skipBox.focus()
        }
      }
    // scrub by a small amount
    } else {
      myVideo.currentTime += fineMode.checked ? 0.0417 : 0.417
    }
  } else {
    myVideo.pause();
    isFF = false
  }
}

/*
* Backwards Skip part of the video.
*
* Called by back button.
*/
function backSkip() {
  if (myVideo.paused) {
    var selection = skipBox.value.slice(skipBox.selectionStart,skipBox.selectionEnd).trim();
    // valid time selected, so scrub to next time
    if (selection != '' && !selection.match(/[^\d:.]/)) {
      var index = getTimeIndex(selection);
      if (index != null) {
        if (shiftMode.checked) {
          // first go there
          myVideo.currentTime = fromHMS(timeLabels[0][index]);
          // now scrub by a small amount
          myVideo.currentTime -= fineMode.checked ? 0.0417 : 0.417;
          // and write it in
          writeIn(toHMS(myVideo.currentTime),true);
          skipBox.focus()
        } else {
          var nextIndex = index - 1;
          if (nextIndex < 0) nextIndex = timeLabels[0].length - 1;
          myVideo.currentTime = fromHMS(timeLabels[0][nextIndex]);
          skipBox.selectionStart = timeLabels[1][nextIndex];
          skipBox.selectionEnd = timeLabels[2][nextIndex];
          skipBox.focus()
        }
      }
    // scrub by a small amount
    } else {
      myVideo.currentTime -= fineMode.checked ? 0.0417 : 0.417
    }
  } else {
    myVideo.pause();
    isFF = false
  }
}

var isFF = false;

/*
* Toggles normal and max speeds
*/
function toggleFF() {
  //if paused, restart, no speed change
  if (myVideo.paused) {
    isFF = false;
    myVideo.muted = false;
    myVideo.playbackRate = 1;
    myVideo.play()
  // if playing, set speed
  } else {                      
    if (isFF) {
      isFF = false;
      myVideo.muted = false;
      myVideo.playbackRate = 1
    } else {
      isFF = true;
      myVideo.muted = true;
      myVideo.playbackRate = 16
    }
  }
}

// for screenshots
var canvas = document.createElement('canvas');
canvas.width = 320;  //for full scale: myVideo.videoWidth - 100 
canvas.height = 240;
var ctx = canvas.getContext('2d')

// TODO: makeShot already declared. Erase.
// //to take a screen shot
// function makeShot() {
//  myVideo.pause();
//  skipBox.value = toHMS(myVideo.currentTime) + '\n' + skipBox.value;    //put time at start
//    //draw image to canvas. scale to target dimensions
//  canvas.width = myVideo.videoWidth / myVideo.videoHeight * canvas.height;
//  ctx.drawImage(myVideo, 0, 0, canvas.width, canvas.height);

//    //convert to desired file format
//  var dataURI = canvas.toDataURL('image/jpeg'); // can also use 'image/png' but the file is 10x bigger
//  screenShot.src = dataURI
// }

/*
* Scrub to first time in the box, unless a time is selected
*/
function scrub2shot() {
  myVideo.pause();
  var selection = skipBox.value.slice(skipBox.selectionStart,skipBox.selectionEnd).trim();
  // valid time selected, so scrub to it
  if (selection != '' && !selection.match(/[^\d:.]/)) {
    var index = getTimeIndex(selection);
    if (index != null) {
      myVideo.currentTime = fromHMS(timeLabels[0][index]);
      skipBox.focus()
    }
  // Scrub to 1st time
  } else {
    myVideo.currentTime = fromHMS(timeLabels[0][0])
  }
}

var isSuper = false;

/*
* Put the screenshot on top of the video so a perfect match can be found, and back.
*/
function moveShot() {
  if (isSuper) {
    isSuper = false;
    screenShot.height = 240;
    screenShot.width = myVideo.videoWidth / myVideo.videoHeight * 240;
    screenShot.style.position = '';
    screenShot.style.top = '';
    screenShot.style.left = '';
    screenShot.style.opacity = ''
  } else {
    isSuper = true;
    //rescales the picture
    screenShot.height = myVideo.videoHeight;
    screenShot.width = myVideo.videoWidth;
    screenShot.style.position = 'absolute';
    screenShot.style.top = myVideo.offsetTop + 'px';
    screenShot.style.left = myVideo.offsetLeft + 'px';
    screenShot.style.opacity = "50%"    
  }
}

var timeLabels = [];

/*
* Remakes array timeLabels containing HMS times, 
* plus their positions in the box [HMS time, start, end].
*/
function makeTimeLabels() {
  //string, startPosition, endPosition
  timeLabels = [[],[],[]];
  var text = skipBox.value,
    string, start, end = 0;
  var matches = text.match(/([\d:.]+)/g);
  
  if (matches) {
    for (var i = 0; i < matches.length; i++) {
      string = matches[i];
      timeLabels[0][i] = string;
      start = text.indexOf(string,end);
      timeLabels[1][i] = start;
      end = start + string.length;
      timeLabels[2][i] = end;
    }
  }
}

/*
* Toggle instructions on and off.
*/
function toggleHelp() {
  if (instructions.style.display == 'none') {
    instructions.style.display = 'block';
  } else {
    instructions.style.display = 'none';
  }
}

// To move and resize superimposed shot
document.onkeydown = checkKey;

function checkKey(e) {
  // This only works when a screenshot is superimposed on the video.
  if (isSuper) {
    e = e || window.event;
    // alt combinations resize, regular moves, hold shift for fine movement
    if (e.altKey) {
      if (e.keyCode == '38') {
        screenShot.height -= e.shiftKey ? 1 : 10;
      } else if (e.keyCode == '40') {
        screenShot.height += e.shiftKey ? 1 : 10;
      } else if (e.keyCode == '37') {
        screenShot.width -= e.shiftKey ? 1 : 10;
      } else if (e.keyCode == '39') {
        screenShot.width += e.shiftKey ? 1 : 10;
      }
    // move shot
    } else {
      if(e.keyCode == '38') {
        screenShot.style.top = parseInt(screenShot.style.top.slice(0,-2)) - (e.shiftKey ? 1 : 10) + 'px';
      } else if (e.keyCode == '40') {
        screenShot.style.top = parseInt(screenShot.style.top.slice(0,-2)) + (e.shiftKey ? 1 : 10) + 'px';
      } else if (e.keyCode == '37') {
        screenShot.style.left = parseInt(screenShot.style.left.slice(0,-2)) - (e.shiftKey ? 1 : 10) + 'px';
      } else if (e.keyCode == '39') {
        screenShot.style.left = parseInt(screenShot.style.left.slice(0,-2)) + (e.shiftKey ? 1 : 10) + 'px';
      }
    }
  }
}

checkBoxes.addEventListener('change', setActions);

skipFile.addEventListener('change', loadFileAsURL);

subFile.addEventListener('change', loadSubs);

shiftBtn.addEventListener('click', shiftTimes);

timeBtn.addEventListener('click', function() { writeIn(toHMS(myVideo.currentTime)) });

arrowBtn.addEventListener('click', function() { writeIn(' --> ') });

instructions.style.display = 'none';
help.addEventListener('click', toggleHelp);

saveFile.addEventListener('click', function() {
  if (!name) name = prompt('Enter the file name. Extension .skp wil be added');
  download(skipBox.value + '\n' + screenShot.src, name + '.skp', "text/plain"); 
  boxMsg.textContent = 'File saved with name ' + name + '.skp';
});

fwdBtn.addEventListener('click', fwdSkip);

fFwdBtn.addEventListener('click', toggleFF);

backBtn.addEventListener('click', backSkip);

shotTimeBtn.addEventListener('click', scrub2shot);

moveBtn.addEventListener('click', moveShot);

syncBtn.addEventListener('click', syncTimes);

shotBtn.addEventListener('click', makeShot);

skipBox.addEventListener('change', function() {
  setTimeout(
    function() {
      cuts = PF_SRT.parse(skipBox.value);
      setActions();
      makeTimeLabels()
    },
    100
  );
});

/*
* Faster way to check for content depending on browser.
*
* @param {String} containerStr.
* @param {String} stringArray.
* @param {String} regex         - Regular expression to search for.
*
* @return {Boolean} Boolean indicating if regex and stringArray content should match.
*/
function isContained(containerStr, stringArray, regex) {
  var result = false;
  
  if (isChrome) {
    for (var i = 0; i < stringArray.length; i++) {
      result = result || containerStr.indexOf(stringArray[i]) != -1;
    }
  } else if (isFirefox) {
    result = containerStr.search(regex) != -1;
  } else if (isSafari || isEdge) {
    result = regex.test(containerStr);
  } else {
    result = !!containerStr.match(regex);
  }
  return result;
}

/*
* To decide whether a particular content is to be skipped, according to check boxes.
* Allows alternative and incomplete keywords.
*
* @param {String} label - Label to check if it is to be skipped.
*
· @return {Boolean} Boolean indicating whether it needs to be skipped.
*/
function isSkipped(label) {
  if (isContained(label, ['sex', 'nud'], /sex|nud/) && sexMode.checked) {
    return true;
  } else if (isContained(label, ['vio', 'gor'], /vio|gor/) && violenceMode.checked) {
    return true;
  } else if (isContained(label, ['pro', 'cur', 'hat'], /pro|cur|hat/) && curseMode.checked) {
    return true;
  } else if (isContained(label, ['alc', 'dru', 'smo'], /alc|dru|smo/) && boozeMode.checked) {
    return true;
  } else if (isContained(label, ['fri', 'sca', 'int'], /fri|sca|int/) && scareMode.checked) {
    return true;
  } else if (isContained(label, ['oth', 'bor'], /oth|bor/) && otherMode.checked) {
    return true;
  } else {
    return false;
  }
}

/*
* Fills the action field in object cuts, according to the position of the check boxes
* and the text at each time.
*/
function setActions() {
  for (var i = 0; i < cuts.length; i++) {
    var label = cuts[i].text.toLowerCase(),
      isAudio = isContained(label, ['aud','sou','spe','wor'], /aud|sou|spe|wor/),
      isVideo = isContained(label,['vid','ima','img'],/vid|ima|img/);
    if (!isAudio && !isVideo) {
      cuts[i].action = isSkipped(label) ? 'skip' : '';
    } else if (isAudio) {
      cuts[i].action = isSkipped(label) ? 'mute' : '';
    } else {
      cuts[i].action = isSkipped(label) ? 'blank' : '';
    }
  }
}

var prevAction = '';

// to skip video during playback
myVideo.ontimeupdate = function() {
  var action = '', startTime, endTime;
  //find out what action to take, according to timing and setting in cuts object.
  for (var i = 0; i < cuts.length; i++) {
    startTime = cuts[i].startTime;
    endTime = cuts[i].endTime;
    if (myVideo.currentTime > startTime && myVideo.currentTime < endTime) {
      action = cuts[i].action;
      break;
    } else {
      action = '';
    }
  }

  // Apply action to the DOM if there's a change
  if (action == prevAction){
    return;
  } else if (action == 'skip') {
    myVideo.currentTime = endTime;
  } else if (action == 'blank') {
    myVideo.style.opacity =  0;
  } else if (action == 'mute') {
    myVideo.muted = true;
    if (myVideo.textTracks.length > 0) myVideo.textTracks[0].mode = 'disabled';
  } else {
    myVideo.style.opacity =  '';
    myVideo.muted = false;
    if (myVideo.textTracks.length > 0) myVideo.textTracks[0].mode = 'showing';
  }
  prevAction = action;
}
</script>
</body>
</html>